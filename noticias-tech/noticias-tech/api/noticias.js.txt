// api/noticias.js
export default async function handler(req, res) {
  const apiKey = process.env.NEWS_API_KEY;
  
  if (!apiKey) {
    return res.status(500).json({ error: "Falta la API Key" });
  }

  const url = `https://newsapi.org/v2/top-headlines?category=technology&country=us&pageSize=20&apiKey=${apiKey}`;

  try {
    const response = await fetch(url);
    const data = await response.json();

    // Traducir solo si es necesario (ejemplo: título en inglés)
    const traducidos = await Promise.all(
      data.articles.map(async (articulo) => {
        if (articulo.title && /[A-Za-z]{10,}/.test(articulo.title)) {
          try {
            const body = new URLSearchParams({
              q: articulo.title,
              source: 'en',
              target: 'es',
              format: 'text'
            });

            const traduccion = await fetch('https://libretranslate.de/translate', {
              method: 'POST',
              body,
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            });

            const traduccionData = await traduccion.json();
            articulo.title = traduccionData.translatedText;
          } catch (err) {
            console.warn("Error traduciendo título:", err.message);
          }
        }
        return articulo;
      })
    );

    data.articles = traducidos;
    res.status(200).json(data);
  } catch (error) {
    res.status(500).json({ error: "Error al obtener noticias" });
  }
}